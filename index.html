<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Controle de Fretes - Caminhões</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#111827" />
  <link rel="manifest" href="manifest.json">

  <style>
    /* Estilos básicos só para ficar organizado visualmente */
    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      padding: 0;
      background: #F1F5F9;
      color: #0F172A;
    }

    header {
      background: #111827;
      color: #f9fafb;
      padding: 16px;
    }

    header h1 {
      margin: 0;
      font-size: 20px;
    }

    header p {
      margin: 4px 0 0;
      font-size: 13px;
      opacity: 0.8;
    }

    .app-container {
      max-width: 1100px;
      margin: 0 auto;
      padding: 16px;
    }

    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }

    .tab-button {
      border: none;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      background: #e5e7eb;
      color: #111827;
      font-size: 14px;
    }

    .tab-button.active {
      background: #1E293B;
      color: #f9fafb;
    }

    .card {
      background: #FFFFFF;
      border-radius: 14px;
      padding: 24px;
      margin-bottom: 40px;
      border: 1px solid #E2E8F0;
      box-shadow: 0 12px 30px rgba(15, 23, 42, 0.08);
    }

    .card h2,
    .card h3 {
      margin-top: 0;
      font-size: 1.3rem;
      color: #1E293B;
    }

    .auth-card h2 {
      margin-bottom: 4px;
    }

    .auth-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 12px;
    }

    .status-pill {
      padding: 4px 12px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
      background: #E2E8F0;
      color: #475569;
    }

    .pill-ok {
      background: rgba(22, 163, 74, 0.15);
      color: #16A34A;
    }

    .pill-alert {
      background: rgba(220, 38, 38, 0.15);
      color: #DC2626;
    }

    .auth-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 12px;
      margin-top: 16px;
    }

    .auth-grid .actions {
      align-items: flex-end;
    }

    .filters-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 16px;
      margin-top: 16px;
      align-items: end;
    }

    .filter-actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }

    .card-header-between {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }

    .financial-table td {
      font-size: 13px;
    }

    .datalist-hint {
      font-size: 12px;
      color: #475569;
      margin-top: 4px;
    }

    .auth-error {
      margin-top: 10px;
      font-size: 13px;
      color: #DC2626;
    }

    .auth-error.success {
      color: #16A34A;
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .chart-header {
      display: flex;
      align-items: flex-end;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }

    .chart-controls {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: #4b5563;
    }

    .chart-wrapper {
      margin-top: 16px;
    }

    .summary-large .summary-box {
      padding: 18px;
    }

    .summary-value {
      font-size: 26px;
      font-weight: 700;
      color: #0F172A;
      margin: 6px 0;
    }

    .summary-subtext {
      font-size: 12px;
      color: #475569;
    }

    .driver-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 20px;
      margin-top: 16px;
    }

    .driver-card {
      border: 1px solid #E2E8F0;
      border-radius: 16px;
      padding: 20px;
      background: #ffffff;
      display: flex;
      flex-direction: column;
      gap: 12px;
      box-shadow: 0 15px 35px rgba(15, 23, 42, 0.08);
    }

    .driver-card h4 {
      margin: 0;
      font-size: 17px;
      color: #111827;
    }

    .driver-meta {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      color: #475569;
    }

    .driver-metrics {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 12px;
      font-size: 12px;
      color: #475569;
    }

    .driver-metrics span {
      display: block;
      font-size: 15px;
      font-weight: 600;
      color: #0F172A;
    }

    .link-button {
      border: none;
      background: none;
      color: #2563EB;
      cursor: pointer;
      font-size: 13px;
      padding: 0;
    }

    .weeks-wrapper {
      border-top: 1px dashed #E2E8F0;
      padding-top: 12px;
      margin-top: 8px;
    }

    .weeks-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 10px;
      margin-top: 8px;
    }

    .week-card {
      border: 1px solid #E2E8F0;
      border-radius: 12px;
      padding: 12px;
      background: #F8FAFC;
      font-size: 13px;
    }

    .week-card.week-highlight {
      border-color: rgba(22, 163, 74, 0.6);
      box-shadow: 0 0 0 1px rgba(22, 163, 74, 0.2);
    }

    .week-card strong {
      display: block;
      margin-bottom: 4px;
      color: #0F172A;
    }

    .indicators-grid .summary-box {
      padding: 14px;
    }

    .indicator-label {
      font-size: 12px;
      color: #475569;
    }

    .ranking-list {
      margin-top: 16px;
    }

    .ranking-list ol {
      margin: 0;
      padding-left: 18px;
    }

    .ranking-list li {
      font-size: 14px;
      margin-bottom: 4px;
      color: #0F172A;
    }

    .admin-lock-hint {
      margin-top: 8px;
      font-size: 12px;
      color: #475569;
    }

    .section-divider {
      border: none;
      border-top: 1px solid #E2E8F0;
      margin: 32px 0;
    }

    .section-title {
      font-size: 1.3rem;
      color: #1E293B;
      margin: 0 0 8px;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
      margin-bottom: 12px;
    }

    label {
      display: block;
      font-size: 12px;
      margin-bottom: 4px;
      color: #475569;
    }

    input, select {
      width: 100%;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid #E2E8F0;
      font-size: 14px;
      background: #ffffff;
    }

    input:focus, select:focus {
      outline: none;
      border-color: #1E293B;
    }

    .actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 8px;
    }

    .btn {
      padding: 10px 18px;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      font-size: 14px;
    }

    .btn-primary {
      background: #1E293B;
      color: #f9fafb;
    }

    .btn-secondary {
      background: #E2E8F0;
      color: #1E293B;
    }

    .btn-danger {
      background: rgba(220, 38, 38, 0.15);
      color: #DC2626;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      background: #ffffff;
      border: 1px solid #E2E8F0;
    }

    th, td {
      padding: 12px 14px;
      border-bottom: 1px solid #E2E8F0;
      text-align: left;
      white-space: nowrap;
    }

    th {
      background: #E2E8F0;
      position: sticky;
      top: 0;
      z-index: 1;
      text-transform: uppercase;
      font-size: 11px;
      letter-spacing: 0.04em;
      color: #475569;
    }

    .table-wrapper {
      max-height: 360px;
      overflow: auto;
      border-radius: 12px;
      border: 1px solid #E2E8F0;
      margin-top: 12px;
      background: #fff;
    }

    .info-text {
      font-size: 13px;
      color: #475569;
    }

    .summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px;
      margin-top: 16px;
    }

    .summary-box {
      background: #ffffff;
      padding: 18px;
      border-radius: 14px;
      border: 1px solid #E2E8F0;
      font-size: 13px;
      box-shadow: 0 12px 24px rgba(15, 23, 42, 0.06);
    }

    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
      background: rgba(56, 189, 248, 0.2);
      color: #1E3A8A;
    }

    .badge-week {
      background: rgba(56, 189, 248, 0.2);
      color: #1E3A8A;
    }

    .text-right {
      text-align: right;
    }

    .text-muted {
      color: #9ca3af;
      font-size: 12px;
    }

    .hidden {
      display: none !important;
    }

    .admin-locked {
      display: none !important;
    }

    @media (max-width: 600px) {
      header h1 {
        font-size: 18px;
      }
      header p {
        font-size: 12px;
      }
    }
  </style>
</head>
<body>

<header>
  <h1>Controle de Fretes</h1>
  <p>Registro de fretes por motorista e caminhão, com visão semanal e mensal.</p>
</header>

<div class="app-container">

  <!-- Abas principais: Motorista x Chefe -->
  <div class="card auth-card" id="loginCard">
    <div class="auth-header">
      <div>
        <h2>Entrar no sistema</h2>
        <p class="info-text">
          Acesse com Google ou com seu e-mail. Administradores enxergam o painel completo; motoristas veem apenas a própria área.
        </p>
      </div>
      <span class="status-pill pill-alert" id="loginStatus">Desconectado</span>
    </div>

    <div class="auth-grid">
      <div>
        <label for="loginEmail">E-mail</label>
        <input type="email" id="loginEmail" placeholder="voce@empresa.com" autocomplete="username" />
      </div>
      <div>
        <label for="loginPassword">Senha</label>
        <input type="password" id="loginPassword" placeholder="••••••••" autocomplete="current-password" />
      </div>
      <div class="actions">
        <button class="btn btn-primary" id="btnLoginEmail">Entrar</button>
        <button class="btn btn-secondary" id="btnLoginGoogle">Entrar com Google</button>
      </div>
    </div>

    <div id="loginSessaoAtiva" class="hidden">
      <p>Logado como <strong id="usuarioNome">-</strong> (<span id="usuarioTipo">-</span>)</p>
      <div class="actions">
        <button class="btn btn-secondary" id="btnLogout">Sair</button>
      </div>
    </div>

    <p class="auth-error hidden" id="loginFeedback"></p>
  </div>

  <div class="tabs">
    <button class="tab-button active" data-tab="motorista-tab">Área do Motorista</button>
    <button class="tab-button hidden" data-tab="chefe-tab" id="chefeTabButton">Painel do Admin</button>
  </div>

  <!-- ========== ÁREA DO MOTORISTA ========== -->
  <section id="motorista-tab" class="tab-content">
    <div class="card">
      <h2>Lançar novo frete</h2>
      <p class="info-text">
        Preencha os dados do frete. Se você não informar o valor do frete,
        o sistema calcula automaticamente: <strong>frete = peso líquido × valor por tonelada</strong>.
      </p>

      <div class="form-grid">
        <div>
          <label for="motoristaNome">Nome do motorista</label>
          <input type="text" id="motoristaNome" placeholder="Ex: João da Silva" />
        </div>
        <div>
          <label for="caminhaoId">Caminhão (identificação)</label>
          <input type="text" id="caminhaoId" placeholder="Ex: Truck 01 / Placa ABC-1234" />
        </div>
        <div>
          <label for="dataFrete">Data</label>
          <input type="date" id="dataFrete" />
        </div>
        <div>
          <label for="notaFrete">Nota</label>
          <input type="text" id="notaFrete" placeholder="Número da nota" />
        </div>
        <div>
          <label for="cteFrete">CTE</label>
          <input type="text" id="cteFrete" placeholder="Número do CTE" />
        </div>
        <div>
          <label for="pesoBruto">Peso bruto (kg)</label>
          <input type="number" id="pesoBruto" step="0.01" placeholder="Ex: 28000" />
        </div>
        <div>
          <label for="pesoLiquido">Peso líquido (kg)</label>
          <input type="number" id="pesoLiquido" step="0.01" placeholder="Ex: 27000" />
        </div>
        <div>
          <label for="valorTonelada">Valor por tonelada (R$)</label>
          <input type="number" id="valorTonelada" step="0.01" placeholder="Ex: 85,50" />
        </div>
        <div>
          <label for="freteTotal">
            Frete total (R$)
            <span class="text-muted">(preenchido automaticamente)</span>
          </label>
          <input type="number" id="freteTotal" step="0.01" placeholder="Ex: 2300,00" />
        </div>
      </div>

      <div class="actions">
        <button class="btn btn-primary" id="btnSalvarFrete">Salvar frete</button>
      </div>
    </div>

    <div class="card">
      <h3>Fretes lançados</h3>
      <p class="info-text">
        Os fretes ficam no Firestore com sincronização offline. Motoristas só enxergam e editam os próprios registros.
      </p>

      <div class="table-wrapper">
        <table id="tabelaFretesMotorista">
          <thead>
            <tr>
              <th>Data</th>
              <th>Semana</th>
              <th>Motorista</th>
              <th>Caminhão</th>
              <th>Nota</th>
              <th>CTE</th>
              <th class="text-right">Peso líq. (kg)</th>
              <th class="text-right">R$/ton</th>
              <th class="text-right">Frete (R$)</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody>
            <!-- Linhas geradas via JS -->
          </tbody>
        </table>
      </div>

      <div class="summary-grid">
        <div class="summary-box">
          <strong>Total de fretes (R$):</strong>
          <div id="totalFretesMotorista">0,00</div>
        </div>
      </div>
    </div>

    <div class="card" id="cardResumoMotorista">
      <div class="card-header-between">
        <div>
          <h3 class="section-title">Resumo financeiro do motorista</h3>
          <p class="info-text">Comissão fixa de 10% sobre o frete bruto somada ao salário definido pelo administrador.</p>
        </div>
      </div>

      <p class="info-text" id="mensagemResumoMotorista">Informe o nome do motorista para ver o resumo.</p>
      <div class="summary-grid hidden" id="resumoMotoristaGrid">
        <div class="summary-box">
          <span class="summary-subtext">Motorista</span>
          <div class="summary-value" id="resumoMotoristaNome">-</div>
        </div>
        <div class="summary-box">
          <span class="summary-subtext">Total de fretes</span>
          <div class="summary-value" id="resumoMotoristaFrete">R$ 0,00</div>
          <p class="summary-subtext">Soma de todas as viagens lançadas</p>
        </div>
        <div class="summary-box">
          <span class="summary-subtext">Comissão (10%)</span>
          <div class="summary-value" id="resumoMotoristaComissao">R$ 0,00</div>
          <p class="summary-subtext">Calculada sobre o frete bruto</p>
        </div>
        <div class="summary-box">
          <span class="summary-subtext">Salário definido pelo admin</span>
          <div class="summary-value" id="resumoMotoristaSalario">R$ 0,00</div>
          <p class="summary-subtext" id="resumoMotoristaSalarioHint">Atualize o salário na área do admin.</p>
        </div>
        <div class="summary-box">
          <span class="summary-subtext">Total previsto para pagamento</span>
          <div class="summary-value" id="resumoMotoristaTotalPrevisto">R$ 0,00</div>
          <p class="summary-subtext">Salário + comissão</p>
        </div>
      </div>
    </div>
  </section>

  <!-- ========== ÁREA DO ADMIN ========== -->
  <section id="chefe-tab" class="tab-content hidden admin-only">
    <div class="card" id="adminFiltersCard">
      <div class="card-header-between">
        <div>
          <h2 class="section-title">Painel do administrador</h2>
          <p class="info-text">
            Filtre o período e visualize rapidamente os totais, motoristas e indicadores.
          </p>
        </div>
      </div>
      <div class="filters-grid">
        <div>
          <label for="filtroMesChefe">Mês de referência</label>
          <input type="month" id="filtroMesChefe" />
        </div>
        <div>
          <label for="filtroMotoristaChefe">Motorista</label>
          <select id="filtroMotoristaChefe">
            <option value="">Todos</option>
          </select>
        </div>
        <div>
          <label for="filtroCaminhaoChefe">Caminhão</label>
          <select id="filtroCaminhaoChefe">
            <option value="">Todos</option>
          </select>
        </div>
        <div>
          <label for="percentualComissaoChefe">Percentual de comissão (%)</label>
          <input type="number" id="percentualComissaoChefe" step="0.1" min="0" max="100" value="10" />
        </div>
        <div class="filter-actions">
          <button class="btn btn-primary" id="btnAplicarFiltroChefe">Aplicar filtro</button>
        </div>
      </div>
    </div>

    <div class="summary-grid summary-large" id="cardsResumoMes">
      <div class="summary-box">
        <span class="summary-subtext">Total de frete no mês</span>
        <div class="summary-value" id="resumoTotalFrete">R$ 0,00</div>
        <p class="summary-subtext">Período de acordo com os filtros</p>
      </div>
      <div class="summary-box">
        <span class="summary-subtext">Peso total transportado</span>
        <div class="summary-value" id="resumoPesoTransportado">0,00 t</div>
        <p class="summary-subtext">Soma do peso líquido</p>
      </div>
      <div class="summary-box">
        <span class="summary-subtext">Comissão total</span>
        <div class="summary-value" id="resumoComissaoTotal">R$ 0,00</div>
        <p class="summary-subtext">Aplicando o percentual escolhido</p>
      </div>
      <div class="summary-box">
        <span class="summary-subtext">Total da folha</span>
        <div class="summary-value" id="resumoFolhaTotal">R$ 0,00</div>
        <p class="summary-subtext">Salários + comissões</p>
      </div>
    </div>

    <hr class="section-divider">

    <div class="card">
      <div class="card-header-between">
        <h3 class="section-title">Motoristas no período</h3>
        <p class="info-text">Frete bruto, comissões, salários e viagens.</p>
      </div>
      <div id="cardsMotoristasResumo" class="driver-grid">
        <div class="info-text">Nenhum frete encontrado para o filtro atual.</div>
      </div>
    </div>

    <hr class="section-divider">
    <div class="card">
      <div class="card-header-between">
        <h3 class="section-title">Resumo por semana</h3>
        <p class="info-text">Totais gerais por semana dentro do mês filtrado.</p>
      </div>
      <div id="resumoSemanasGeral" class="weeks-grid"></div>
    </div>

    <hr class="section-divider">
    <div class="card">
      <h3 class="section-title">Fretes detalhados</h3>
      <p class="info-text">Lista completa de viagens com os filtros aplicados.</p>
      <div class="table-wrapper">
        <table id="tabelaFretesChefe">
          <thead>
            <tr>
              <th>Data</th>
              <th>Semana</th>
              <th>Motorista</th>
              <th>Caminhão</th>
              <th>Nota</th>
              <th>CTE</th>
              <th class="text-right">Peso líq. (kg)</th>
              <th class="text-right">R$/ton</th>
              <th class="text-right">Frete (R$)</th>
            </tr>
          </thead>
          <tbody>
            <!-- Linhas geradas via JS -->
          </tbody>
        </table>
      </div>
    </div>

    <hr class="section-divider">
    <div class="card" id="cardIndicadores">
      <h3 class="section-title">Indicadores consolidados</h3>
      <p class="info-text">Médias gerais e ranking dos motoristas no mês.</p>
      <div class="summary-grid indicators-grid">
        <div class="summary-box">
          <span class="indicator-label">Frete médio por viagem</span>
          <div class="summary-value" id="indicadorFreteMedio">R$ 0,00</div>
        </div>
        <div class="summary-box">
          <span class="indicator-label">Peso médio por viagem</span>
          <div class="summary-value" id="indicadorPesoMedio">0,00 t</div>
        </div>
        <div class="summary-box">
          <span class="indicator-label">Semana com maior frete</span>
          <div class="summary-value" id="indicadorSemanaAlta">-</div>
        </div>
        <div class="summary-box">
          <span class="indicator-label">Semana com menor frete</span>
          <div class="summary-value" id="indicadorSemanaBaixa">-</div>
        </div>
      </div>
      <div class="ranking-list">
        <h4>Ranking de motoristas</h4>
        <ol id="listaRankingMotoristas"></ol>
      </div>
    </div>

    <hr class="section-divider">

    <div class="card admin-only" id="cardSalariosMotoristas">
      <h3 class="section-title">Salários dos motoristas</h3>
      <p class="info-text">
        Defina o salário fixo de cada motorista. O sistema soma esse valor com a comissão configurada no filtro acima para chegar ao pagamento.
      </p>

      <div class="form-grid">
        <div>
          <label for="salarioMotoristaNome">Motorista</label>
          <input type="text" id="salarioMotoristaNome" list="motoristasDatalist" placeholder="Ex: João da Silva" />
          <datalist id="motoristasDatalist"></datalist>
          <p class="datalist-hint">Sugestões preenchidas automaticamente com os fretes lançados.</p>
        </div>
        <div>
          <label for="salarioMotoristaValor">Salário fixo (R$)</label>
          <input type="number" id="salarioMotoristaValor" step="0.01" min="0" placeholder="Ex: 3500,00" />
        </div>
        <div class="actions">
          <button class="btn btn-primary" id="btnSalvarSalario">Salvar salário</button>
        </div>
      </div>

      <div class="table-wrapper">
        <table id="tabelaSalariosMotoristas">
          <thead>
            <tr>
              <th>Motorista</th>
              <th class="text-right">Salário (R$)</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody>
            <!-- preenchido via JS -->
          </tbody>
        </table>
      </div>
    </div>

    <div class="card admin-only" id="cardGestaoMotoristas">
      <div class="card-header-between">
        <div>
          <h3 class="section-title">Motoristas cadastrados</h3>
          <p class="info-text">Crie e edite perfis de motoristas com salário e caminhão.</p>
        </div>
      </div>

      <div class="form-grid">
        <div>
          <label for="novoMotoristaNome">Nome</label>
          <input type="text" id="novoMotoristaNome" placeholder="Nome completo" />
        </div>
        <div>
          <label for="novoMotoristaEmail">E-mail</label>
          <input type="email" id="novoMotoristaEmail" placeholder="motorista@empresa.com" />
        </div>
        <div>
          <label for="novoMotoristaSenha">Senha inicial</label>
          <input type="password" id="novoMotoristaSenha" placeholder="Senha temporária" />
        </div>
        <div>
          <label for="novoMotoristaSalario">Salário (R$)</label>
          <input type="number" id="novoMotoristaSalario" min="0" step="0.01" />
        </div>
        <div>
          <label for="novoMotoristaCaminhao">Caminhão</label>
          <input type="text" id="novoMotoristaCaminhao" placeholder="Identificação do caminhão" />
        </div>
      </div>
      <div class="actions">
        <button class="btn btn-primary" id="btnCriarMotorista">Criar novo motorista</button>
      </div>

      <div class="table-wrapper">
        <table id="tabelaMotoristasAdmin">
          <thead>
            <tr>
              <th>Nome</th>
              <th>Email</th>
              <th>Salário</th>
              <th>Caminhão</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>


</div>

<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBoMun-Hn757Oq08yN9dQ-k9Z5ANkuEIfk",
    authDomain: "now-transportes.firebaseapp.com",
    projectId: "now-transportes",
    storageBucket: "now-transportes.firebasestorage.app",
    messagingSenderId: "304411297708",
    appId: "1:304411297708:web:8d119de19239db258a9c09",
    measurementId: "G-DCJQG1Y40S"
  };

  const firebaseApp = firebase.apps.length ? firebase.app() : firebase.initializeApp(firebaseConfig);
  const secondaryApp = firebase.apps.find(app => app.name === "secondary") || firebase.initializeApp(firebaseConfig, "secondary");
  const auth = firebaseApp.auth();
  const secondaryAuth = secondaryApp.auth();
  const db = firebase.firestore();

  firebase.firestore().enablePersistence({ synchronizeTabs: true }).catch(error => {
    console.warn("Persistência offline não pôde ser ativada.", error);
  });

  const COLECAO_FRETES = "fretes";
  const COLECAO_USUARIOS = "users";
  const COMISSAO_PADRAO = 10;

  let usuarioAtual = null;
  let perfilAtual = null;
  let fretes = [];
  let motoristas = [];
  let unsubscribeFretes = null;
  let unsubscribeMotoristas = null;
  let unsubscribePerfil = null;

  const tabelaFretesMotoristaBody = document.querySelector("#tabelaFretesMotorista tbody");
  const tabelaFretesChefeBody = document.querySelector("#tabelaFretesChefe tbody");
  const tabelaSalariosBody = document.querySelector("#tabelaSalariosMotoristas tbody");
  const tabelaMotoristasAdminBody = document.querySelector("#tabelaMotoristasAdmin tbody");
  const totalFretesMotoristaSpan = document.getElementById("totalFretesMotorista");
  const resumoTotalFreteSpan = document.getElementById("resumoTotalFrete");
  const resumoPesoTransportadoSpan = document.getElementById("resumoPesoTransportado");
  const resumoComissaoTotalSpan = document.getElementById("resumoComissaoTotal");
  const resumoFolhaTotalSpan = document.getElementById("resumoFolhaTotal");
  const cardsMotoristasResumo = document.getElementById("cardsMotoristasResumo");
  const resumoSemanasGeralWrapper = document.getElementById("resumoSemanasGeral");
  const rankingMotoristasLista = document.getElementById("listaRankingMotoristas");
  const indicadorFreteMedioSpan = document.getElementById("indicadorFreteMedio");
  const indicadorPesoMedioSpan = document.getElementById("indicadorPesoMedio");
  const indicadorSemanaAltaSpan = document.getElementById("indicadorSemanaAlta");
  const indicadorSemanaBaixaSpan = document.getElementById("indicadorSemanaBaixa");
  const filtroMesChefeInput = document.getElementById("filtroMesChefe");
  const filtroMotoristaChefeSelect = document.getElementById("filtroMotoristaChefe");
  const filtroCaminhaoChefeSelect = document.getElementById("filtroCaminhaoChefe");
  const percentualComissaoChefeInput = document.getElementById("percentualComissaoChefe");
  const motoristaNomeInput = document.getElementById("motoristaNome");
  const caminhaoIdInput = document.getElementById("caminhaoId");
  const dataFreteInput = document.getElementById("dataFrete");
  const notaFreteInput = document.getElementById("notaFrete");
  const cteFreteInput = document.getElementById("cteFrete");
  const pesoBrutoInput = document.getElementById("pesoBruto");
  const pesoLiquidoInput = document.getElementById("pesoLiquido");
  const valorToneladaInput = document.getElementById("valorTonelada");
  const freteTotalInput = document.getElementById("freteTotal");
  const btnSalvarFrete = document.getElementById("btnSalvarFrete");
  const btnSalvarSalario = document.getElementById("btnSalvarSalario");
  const salarioMotoristaNomeInput = document.getElementById("salarioMotoristaNome");
  const salarioMotoristaValorInput = document.getElementById("salarioMotoristaValor");
  const motoristasDatalist = document.getElementById("motoristasDatalist");
  const mensagemResumoMotorista = document.getElementById("mensagemResumoMotorista");
  const resumoMotoristaGrid = document.getElementById("resumoMotoristaGrid");
  const resumoMotoristaNome = document.getElementById("resumoMotoristaNome");
  const resumoMotoristaFrete = document.getElementById("resumoMotoristaFrete");
  const resumoMotoristaComissao = document.getElementById("resumoMotoristaComissao");
  const resumoMotoristaSalario = document.getElementById("resumoMotoristaSalario");
  const resumoMotoristaSalarioHint = document.getElementById("resumoMotoristaSalarioHint");
  const resumoMotoristaTotalPrevisto = document.getElementById("resumoMotoristaTotalPrevisto");
  const loginStatus = document.getElementById("loginStatus");
  const loginFeedback = document.getElementById("loginFeedback");
  const loginEmailInput = document.getElementById("loginEmail");
  const loginPasswordInput = document.getElementById("loginPassword");
  const loginSessaoAtiva = document.getElementById("loginSessaoAtiva");
  const usuarioNomeSpan = document.getElementById("usuarioNome");
  const usuarioTipoSpan = document.getElementById("usuarioTipo");
  const loginCard = document.getElementById("loginCard");
  const tabs = document.querySelector(".tabs");
  const tabButtons = document.querySelectorAll(".tab-button");
  const tabContents = document.querySelectorAll(".tab-content");
  const adminOnlyElements = document.querySelectorAll(".admin-only");
  const adminTabButton = document.getElementById("chefeTabButton");
  const chartRangeSelect = document.getElementById("chartRangeSelect");
  const chartCanvas = document.getElementById("desempenhoChefeChart");
  const chartEmptyMessage = document.getElementById("chartEmptyMessage");
  const btnLoginEmail = document.getElementById("btnLoginEmail");
  const btnLoginGoogle = document.getElementById("btnLoginGoogle");
  const btnLogout = document.getElementById("btnLogout");
  const btnCriarMotorista = document.getElementById("btnCriarMotorista");
  const novoMotoristaNomeInput = document.getElementById("novoMotoristaNome");
  const novoMotoristaEmailInput = document.getElementById("novoMotoristaEmail");
  const novoMotoristaSenhaInput = document.getElementById("novoMotoristaSenha");
  const novoMotoristaSalarioInput = document.getElementById("novoMotoristaSalario");
  const novoMotoristaCaminhaoInput = document.getElementById("novoMotoristaCaminhao");

  let desempenhoChart = null;

  function formatarMoeda(valor) {
    const numero = Number(valor) || 0;
    return numero.toLocaleString("pt-BR", { style: "currency", currency: "BRL", minimumFractionDigits: 2 });
  }

  function formatarNumero(valor) {
    const numero = Number(valor) || 0;
    return numero.toLocaleString("pt-BR", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  }

  function normalizarTexto(valor) {
    return (valor || "").trim().toLowerCase().normalize("NFD").replace(/\p{Diacritic}/gu, "");
  }

  function calcularSemanaDoMes(dataISO) {
    if (!dataISO) return "";
    const data = new Date(dataISO);
    const primeiroDiaMes = new Date(data.getFullYear(), data.getMonth(), 1).getDay();
    const diaDoMes = data.getDate();
    return Math.ceil((diaDoMes + primeiroDiaMes) / 7);
  }

  function preencherSelectComValores(selectEl, valoresSet) {
    if (!selectEl) return;
    const atual = selectEl.value;
    const valores = Array.from(valoresSet).filter(Boolean).sort((a, b) => a.localeCompare(b));
    selectEl.innerHTML = '<option value="">Todos</option>' + valores.map(v => `<option value="${v}">${v}</option>`).join("");
    if (valores.includes(atual)) {
      selectEl.value = atual;
    }
  }

  function obterPercentualComissao() {
    const valor = parseFloat(percentualComissaoChefeInput.value.replace(",", "."));
    return !isNaN(valor) && valor >= 0 ? valor : COMISSAO_PADRAO;
  }

  function atualizarPillLogin(status, ok = false) {
    if (!loginStatus) return;
    loginStatus.textContent = status;
    loginStatus.classList.toggle("pill-ok", ok);
    loginStatus.classList.toggle("pill-alert", !ok);
  }

  function mostrarFeedbackLogin(msg, ok = false) {
    if (!loginFeedback) return;
    if (!msg) {
      loginFeedback.textContent = "";
      loginFeedback.classList.add("hidden");
      loginFeedback.classList.remove("success");
      return;
    }
    loginFeedback.textContent = msg;
    loginFeedback.classList.toggle("hidden", false);
    loginFeedback.classList.toggle("success", ok);
  }

  function definirMesAtualChefe() {
    const hoje = new Date();
    const ano = hoje.getFullYear();
    const mes = String(hoje.getMonth() + 1).padStart(2, "0");
    filtroMesChefeInput.value = `${ano}-${mes}`;
  }

  function ehAdmin() {
    return perfilAtual?.tipo === "admin";
  }

  function aplicarVisibilidadePorPapel() {
    const autenticado = Boolean(usuarioAtual);
    const perfilPronto = Boolean(perfilAtual);

    loginCard?.classList.toggle("hidden", autenticado && perfilPronto);
    loginSessaoAtiva?.classList.toggle("hidden", !autenticado);

    tabs?.classList.toggle("hidden", !autenticado || !perfilPronto);
    tabContents.forEach(tab => tab.classList.toggle("hidden", !autenticado || !perfilPronto));

    adminOnlyElements.forEach(el => el.classList.toggle("hidden", !ehAdmin()));
    adminTabButton?.classList.toggle("hidden", !ehAdmin());

    if (autenticado && perfilPronto) {
      const destino = ehAdmin() ? "chefe-tab" : "motorista-tab";
      tabButtons.forEach(btn => {
        const ativo = btn.dataset.tab === destino;
        btn.classList.toggle("active", ativo);
      });
      tabContents.forEach(sec => sec.classList.toggle("hidden", sec.id !== destino));
    }
  }

  async function carregarPerfil(uid) {
    const docRef = db.collection(COLECAO_USUARIOS).doc(uid);
    const snap = await docRef.get();
    if (!snap.exists) return null;
    return { id: snap.id, ...snap.data() };
  }

  function iniciarListenerPerfil(uid) {
    unsubscribePerfil?.();
    unsubscribePerfil = db.collection(COLECAO_USUARIOS).doc(uid).onSnapshot(doc => {
      perfilAtual = doc.exists ? { id: doc.id, ...doc.data() } : null;
      usuarioNomeSpan.textContent = perfilAtual?.nome || usuarioAtual?.displayName || usuarioAtual?.email || "-";
      usuarioTipoSpan.textContent = perfilAtual?.tipo || "-";
      atualizarPillLogin(perfilAtual ? "Logado" : "Perfil pendente", Boolean(perfilAtual));
      if (!perfilAtual) {
        mostrarFeedbackLogin("Perfil não encontrado. Peça ao administrador para concluir seu cadastro.");
      }
      aplicarVisibilidadePorPapel();
      atualizarResumoMotorista();
      atualizarVisaoChefe();
      atualizarGraficoDesempenho();
    }, error => {
      console.error("Erro no listener de perfil", error);
      mostrarFeedbackLogin("Sem permissão para carregar seu perfil. Confirme seu acesso com o administrador.");
      auth.signOut();
    });
  }

  function iniciarListenerMotoristas() {
    unsubscribeMotoristas?.();
    if (!ehAdmin()) return;
    unsubscribeMotoristas = db.collection(COLECAO_USUARIOS)
      .where("tipo", "==", "motorista")
      .onSnapshot(snapshot => {
        motoristas = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        atualizarTabelaMotoristasAdmin();
        atualizarTabelaSalarios();
        atualizarOpcoesFiltrosChefe();
        atualizarResumoMotorista();
      }, error => {
        console.error("Erro ao listar motoristas", error);
        mostrarFeedbackLogin("Sem permissão para carregar motoristas. Apenas administradores podem acessar.");
      });
  }

  function iniciarListenerFretes() {
    unsubscribeFretes?.();
    if (!usuarioAtual || !perfilAtual) return;

    const base = db.collection(COLECAO_FRETES);
    const query = ehAdmin()
      ? base.orderBy("data")
      : base.where("userId", "==", usuarioAtual.uid).orderBy("data");

    unsubscribeFretes = query.onSnapshot(snapshot => {
      fretes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      atualizarTabelaMotorista();
      atualizarVisaoChefe();
      atualizarGraficoDesempenho();
      atualizarOpcoesFiltrosChefe();
      atualizarDatalistMotoristas();
    }, error => {
      console.error("Erro ao sincronizar fretes", error);
      mostrarFeedbackLogin("Sem permissão para carregar fretes. Confirme se seu perfil está autorizado.");
    });
  }

  auth.onAuthStateChanged(async user => {
    usuarioAtual = user;
    perfilAtual = null;
    fretes = [];
    motoristas = [];

    if (!user) {
      aplicarVisibilidadePorPapel();
      atualizarPillLogin("Desconectado");
      mostrarFeedbackLogin("");
      return;
    }

    loginSessaoAtiva?.classList.remove("hidden");
    usuarioNomeSpan.textContent = user.displayName || user.email || "-";
    usuarioTipoSpan.textContent = "validando...";
    atualizarPillLogin("Validando...", true);
    mostrarFeedbackLogin("");

    iniciarListenerPerfil(user.uid);
    iniciarListenerMotoristas();
    iniciarListenerFretes();
    aplicarVisibilidadePorPapel();
  });

  btnLoginEmail?.addEventListener("click", async () => {
    try {
      mostrarFeedbackLogin("");
      const email = loginEmailInput.value.trim();
      const senha = loginPasswordInput.value.trim();
      if (!email || !senha) {
        mostrarFeedbackLogin("Preencha e-mail e senha.");
        return;
      }
      await auth.signInWithEmailAndPassword(email, senha);
    } catch (error) {
      mostrarFeedbackLogin("Não foi possível entrar: " + (error.message || ""));
    }
  });

  btnLoginGoogle?.addEventListener("click", async () => {
    try {
      mostrarFeedbackLogin("");
      const provider = new firebase.auth.GoogleAuthProvider();
      await auth.signInWithPopup(provider);
    } catch (error) {
      mostrarFeedbackLogin("Falha no login com Google: " + (error.message || ""));
    }
  });

  btnLogout?.addEventListener("click", async () => {
    await auth.signOut();
  });

  async function cadastrarMotorista() {
    const nome = novoMotoristaNomeInput.value.trim();
    const email = novoMotoristaEmailInput.value.trim();
    const senha = novoMotoristaSenhaInput.value.trim();
    const salario = parseFloat(novoMotoristaSalarioInput.value.replace(",", "."));
    const caminhao = novoMotoristaCaminhaoInput.value.trim();

    if (!nome || !email || !senha) {
      alert("Preencha nome, e-mail e senha inicial.");
      return;
    }

    const salarioValido = isNaN(salario) ? 0 : salario;

    try {
      const cred = await secondaryAuth.createUserWithEmailAndPassword(email, senha);
      await db.collection(COLECAO_USUARIOS).doc(cred.user.uid).set({
        nome,
        email,
        tipo: "motorista",
        salario: salarioValido,
        caminhao,
        criadoEm: firebase.firestore.FieldValue.serverTimestamp()
      });
      alert("Motorista criado com sucesso.");
      novoMotoristaNomeInput.value = "";
      novoMotoristaEmailInput.value = "";
      novoMotoristaSenhaInput.value = "";
      novoMotoristaSalarioInput.value = "";
      novoMotoristaCaminhaoInput.value = "";
      await secondaryAuth.signOut();
    } catch (error) {
      console.error(error);
      alert("Erro ao criar motorista: " + (error.message || ""));
    }
  }

  btnCriarMotorista?.addEventListener("click", cadastrarMotorista);

  async function salvarSalario(nome, salario) {
    const motorista = motoristas.find(m => normalizarTexto(m.nome) === normalizarTexto(nome));
    if (!motorista) return;
    await db.collection(COLECAO_USUARIOS).doc(motorista.id).set({ salario }, { merge: true });
  }

  btnSalvarSalario?.addEventListener("click", async () => {
    const nome = salarioMotoristaNomeInput.value.trim();
    const salario = parseFloat(salarioMotoristaValorInput.value.replace(",", "."));
    if (!nome || isNaN(salario)) {
      alert("Informe nome e salário válidos.");
      return;
    }
    await salvarSalario(nome, salario);
    salarioMotoristaNomeInput.value = "";
    salarioMotoristaValorInput.value = "";
  });

  function calcularFreteAutomatico() {
    const pesoLiquido = parseFloat(pesoLiquidoInput.value.replace(",", "."));
    const valorTonelada = parseFloat(valorToneladaInput.value.replace(",", "."));
    if (!isNaN(pesoLiquido) && !isNaN(valorTonelada)) {
      const freteCalculado = pesoLiquido * (valorTonelada / 1000);
      freteTotalInput.value = freteCalculado.toFixed(2);
    }
  }

  pesoLiquidoInput?.addEventListener("input", calcularFreteAutomatico);
  valorToneladaInput?.addEventListener("input", calcularFreteAutomatico);

  btnSalvarFrete?.addEventListener("click", async () => {
    if (!usuarioAtual || !perfilAtual) {
      alert("Faça login antes de lançar fretes.");
      return;
    }

    const caminhaoId = caminhaoIdInput.value.trim();
    const dataFrete = dataFreteInput.value;
    const nota = notaFreteInput.value.trim();
    const cte = cteFreteInput.value.trim();
    const pesoBruto = parseFloat(pesoBrutoInput.value.replace(",", "."));
    const pesoLiquido = parseFloat(pesoLiquidoInput.value.replace(",", "."));
    const valorTonelada = parseFloat(valorToneladaInput.value.replace(",", "."));
    let freteTotal = parseFloat(freteTotalInput.value.replace(",", "."));

    if (!dataFrete) {
      alert("Informe a data do frete.");
      return;
    }

    if (isNaN(freteTotal)) {
      if (!isNaN(pesoLiquido) && !isNaN(valorTonelada)) {
        freteTotal = pesoLiquido * (valorTonelada / 1000);
      }
    }

    const semana = calcularSemanaDoMes(dataFrete);
    const frete = {
      userId: usuarioAtual.uid,
      motoristaNome: perfilAtual?.nome || usuarioAtual.email,
      caminhaoId,
      data: dataFrete,
      semana,
      nota,
      cte,
      pesoBruto: isNaN(pesoBruto) ? null : pesoBruto,
      pesoLiquido: isNaN(pesoLiquido) ? null : pesoLiquido,
      valorTonelada: isNaN(valorTonelada) ? null : valorTonelada,
      freteTotal: isNaN(freteTotal) ? null : freteTotal,
      criadoEm: firebase.firestore.FieldValue.serverTimestamp()
    };

    try {
      await db.collection(COLECAO_FRETES).add(frete);
      alert("Frete salvo com sucesso.");
      notaFreteInput.value = "";
      cteFreteInput.value = "";
      pesoBrutoInput.value = "";
      pesoLiquidoInput.value = "";
      valorToneladaInput.value = "";
      freteTotalInput.value = "";
    } catch (error) {
      alert("Erro ao salvar frete: " + (error.message || ""));
    }
  });

  function atualizarTabelaMotorista() {
    tabelaFretesMotoristaBody.innerHTML = "";
    if (!usuarioAtual) return;

    let totalFretes = 0;

    fretes
      .filter(f => ehAdmin() || f.userId === usuarioAtual.uid)
      .sort((a, b) => (a.data || "").localeCompare(b.data || ""))
      .forEach(f => {
        const tr = document.createElement("tr");

        const tdData = document.createElement("td");
        tdData.textContent = f.data || "-";

        const tdSemana = document.createElement("td");
        if (f.semana) {
          tdSemana.innerHTML = `<span class="badge badge-week">Sem ${f.semana}</span>`;
        } else {
          tdSemana.textContent = "-";
        }

        const tdMotorista = document.createElement("td");
        tdMotorista.textContent = f.motoristaNome || "-";

        const tdCaminhao = document.createElement("td");
        tdCaminhao.textContent = f.caminhaoId || "-";

        const tdNota = document.createElement("td");
        tdNota.textContent = f.nota || "-";

        const tdCte = document.createElement("td");
        tdCte.textContent = f.cte || "-";

        const tdPesoLiquido = document.createElement("td");
        tdPesoLiquido.className = "text-right";
        tdPesoLiquido.textContent = f.pesoLiquido != null ? formatarNumero(f.pesoLiquido) : "-";

        const tdValorTon = document.createElement("td");
        tdValorTon.className = "text-right";
        tdValorTon.textContent = f.valorTonelada != null ? formatarMoeda(f.valorTonelada) : "-";

        const tdFrete = document.createElement("td");
        tdFrete.className = "text-right";
        tdFrete.textContent = f.freteTotal != null ? formatarMoeda(f.freteTotal) : "-";

        const tdAcoes = document.createElement("td");
        if (f.userId === usuarioAtual.uid) {
          const btnExcluir = document.createElement("button");
          btnExcluir.textContent = "Excluir";
          btnExcluir.className = "btn btn-danger";
          btnExcluir.style.fontSize = "11px";
          btnExcluir.addEventListener("click", async () => {
            if (confirm("Deseja realmente excluir este frete?")) {
              await db.collection(COLECAO_FRETES).doc(f.id).delete();
            }
          });
          tdAcoes.appendChild(btnExcluir);
        }

        tr.appendChild(tdData);
        tr.appendChild(tdSemana);
        tr.appendChild(tdMotorista);
        tr.appendChild(tdCaminhao);
        tr.appendChild(tdNota);
        tr.appendChild(tdCte);
        tr.appendChild(tdPesoLiquido);
        tr.appendChild(tdValorTon);
        tr.appendChild(tdFrete);
        tr.appendChild(tdAcoes);

        tabelaFretesMotoristaBody.appendChild(tr);

        if (f.freteTotal) {
          totalFretes += f.freteTotal;
        }
      });

    totalFretesMotoristaSpan.textContent = formatarMoeda(totalFretes);
    atualizarResumoMotorista();
  }

  function obterSalarioPorUserId(userId) {
    const motorista = motoristas.find(m => m.id === userId);
    return motorista ? Number(motorista.salario) || 0 : 0;
  }

  function obterSalarioMotoristaPorNome(nome) {
    const alvo = motoristas.find(m => normalizarTexto(m.nome) === normalizarTexto(nome));
    return alvo ? Number(alvo.salario) || 0 : 0;
  }

  function atualizarResumoMotorista() {
    if (!mensagemResumoMotorista || !resumoMotoristaGrid) return;

    if (!usuarioAtual || !perfilAtual) {
      mensagemResumoMotorista.textContent = "Faça login para ver seu resumo.";
      resumoMotoristaGrid.classList.add("hidden");
      return;
    }

    const fretesDoMotorista = fretes.filter(f => f.userId === usuarioAtual.uid);
    const totalFrete = fretesDoMotorista.reduce((acc, f) => acc + (Number(f.freteTotal) || 0), 0);
    const comissao = totalFrete * (COMISSAO_PADRAO / 100);
    const salario = Number(perfilAtual.salario) || 0;
    const totalPrevisto = salario + comissao;

    resumoMotoristaGrid.classList.remove("hidden");
    resumoMotoristaNome.textContent = perfilAtual.nome || perfilAtual.email || "-";
    resumoMotoristaFrete.textContent = formatarMoeda(totalFrete);
    resumoMotoristaComissao.textContent = formatarMoeda(comissao);
    resumoMotoristaSalario.textContent = formatarMoeda(salario);
    resumoMotoristaTotalPrevisto.textContent = formatarMoeda(totalPrevisto);
    resumoMotoristaSalarioHint.textContent = salario > 0
      ? "Valor cadastrado pelo administrador."
      : "Sem salário definido ainda; peça para o administrador atualizar.";

    mensagemResumoMotorista.textContent = fretesDoMotorista.length
      ? "Resumo calculado a partir dos fretes sincronizados no Firestore."
      : "Nenhum frete lançado para este motorista.";
  }

  function atualizarOpcoesFiltrosChefe() {
    if (!ehAdmin()) return;
    const motoristasSet = new Set();
    const caminhoes = new Set();
    fretes.forEach(f => {
      if (f.motoristaNome) motoristasSet.add(f.motoristaNome.trim());
      if (f.caminhaoId) caminhoes.add(f.caminhaoId.trim());
    });
    motoristas.forEach(m => motoristasSet.add(m.nome));
    preencherSelectComValores(filtroMotoristaChefeSelect, motoristasSet);
    preencherSelectComValores(filtroCaminhaoChefeSelect, caminhoes);
  }

  function obterFretesFiltrados() {
    const mesISO = filtroMesChefeInput.value || new Date().toISOString().slice(0, 7);
    const motoristaFiltro = filtroMotoristaChefeSelect?.value || "";
    const caminhaoFiltro = filtroCaminhaoChefeSelect?.value || "";
    return fretes.filter(f => {
      const data = f.data || "";
      if (!data.startsWith(mesISO)) return false;
      if (motoristaFiltro && f.motoristaNome !== motoristaFiltro) return false;
      if (caminhaoFiltro && f.caminhaoId !== caminhaoFiltro) return false;
      return true;
    });
  }

  function renderizarResumoMes(fretesMes, comissaoPercent, totalFolha) {
    const totalFrete = fretesMes.reduce((acc, f) => acc + (Number(f.freteTotal) || 0), 0);
    const totalPesoKg = fretesMes.reduce((acc, f) => acc + (Number(f.pesoLiquido) || 0), 0);
    const comissaoTotal = totalFrete * (comissaoPercent / 100);
    resumoTotalFreteSpan.textContent = formatarMoeda(totalFrete);
    resumoPesoTransportadoSpan.textContent = `${formatarNumero(totalPesoKg / 1000)} t`;
    resumoComissaoTotalSpan.textContent = formatarMoeda(comissaoTotal);
    resumoFolhaTotalSpan.textContent = formatarMoeda(totalFolha);
  }

  function agruparFretesPorMotorista(lista) {
    const mapa = {};
    lista.forEach(f => {
      const chave = f.userId || f.motoristaNome || "sem-motorista";
      if (!mapa[chave]) {
        mapa[chave] = {
          id: chave,
          nome: f.motoristaNome || "Sem motorista",
          freteTotal: 0,
          pesoTotal: 0,
          viagens: 0,
          semanas: {}
        };
      }
      const registro = mapa[chave];
      const frete = Number(f.freteTotal) || 0;
      const peso = Number(f.pesoLiquido) || 0;
      registro.freteTotal += frete;
      registro.pesoTotal += peso;
      registro.viagens += 1;
      const semana = f.semana || calcularSemanaDoMes(f.data);
      if (semana) {
        if (!registro.semanas[semana]) {
          registro.semanas[semana] = { frete: 0, peso: 0, viagens: 0 };
        }
        registro.semanas[semana].frete += frete;
        registro.semanas[semana].peso += peso;
        registro.semanas[semana].viagens += 1;
      }
    });
    return mapa;
  }

  function criarCardMotorista(info) {
    const card = document.createElement("div");
    card.className = "driver-card";
    card.innerHTML = `
      <div class="driver-meta">
        <h4>${info.nome}</h4>
        <span>${info.viagens} viagens</span>
      </div>
      <div class="driver-metrics">
        <div>
          <span>${formatarMoeda(info.freteTotal)}</span>
          Frete bruto
        </div>
        <div>
          <span>${formatarMoeda(info.comissao)}</span>
          Comissão
        </div>
        <div>
          <span>${formatarMoeda(info.salario)}</span>
          Salário
        </div>
        <div>
          <span>${formatarMoeda(info.totalPrevisto)}</span>
          Total previsto
        </div>
      </div>
      <div class="weeks-wrapper">
        <strong>Semanas</strong>
        <div class="weeks-grid">
          ${Object.entries(info.semanas)
            .sort((a, b) => Number(a[0]) - Number(b[0]))
            .map(([semana, dados]) => `
              <div class="week-card">
                <strong>Semana ${semana}</strong>
                Frete: ${formatarMoeda(dados.frete)}<br>
                Peso: ${formatarNumero(dados.peso / 1000)} t<br>
                Viagens: ${dados.viagens}
              </div>
            `)
            .join("")}
        </div>
      </div>
    `;
    return card;
  }

  function renderizarCardsMotoristas(listaFretes, comissaoPercent) {
    cardsMotoristasResumo.innerHTML = "";
    const mapa = agruparFretesPorMotorista(listaFretes);
    const ids = Object.keys(mapa);
    if (!ids.length) {
      cardsMotoristasResumo.innerHTML = '<div class="info-text">Nenhum frete encontrado para o filtro atual.</div>';
      return { totalFolha: 0, ranking: [] };
    }

    let totalFolha = 0;
    const ranking = [];

    ids.forEach(id => {
      const info = mapa[id];
      const salario = obterSalarioPorUserId(id) || obterSalarioMotoristaPorNome(info.nome);
      const comissao = info.freteTotal * (comissaoPercent / 100);
      const totalPrevisto = salario + comissao;
      totalFolha += totalPrevisto;
      ranking.push({ nome: info.nome, frete: info.freteTotal });
      const card = criarCardMotorista({ ...info, comissao, salario, totalPrevisto });
      cardsMotoristasResumo.appendChild(card);
    });

    ranking.sort((a, b) => b.frete - a.frete);
    return { totalFolha, ranking };
  }

  function renderizarResumoSemanalGeral(listaFretes, comissaoPercent) {
    resumoSemanasGeralWrapper.innerHTML = "";
    const mapa = {};
    listaFretes.forEach(f => {
      const semana = f.semana || calcularSemanaDoMes(f.data);
      if (!semana) return;
      if (!mapa[semana]) {
        mapa[semana] = { frete: 0, peso: 0, viagens: 0 };
      }
      mapa[semana].frete += Number(f.freteTotal) || 0;
      mapa[semana].peso += Number(f.pesoLiquido) || 0;
      mapa[semana].viagens += 1;
    });

    const semanas = Object.keys(mapa);
    if (!semanas.length) {
      resumoSemanasGeralWrapper.innerHTML = '<div class="info-text">Nenhum frete para o período.</div>';
      return [];
    }

    semanas
      .sort((a, b) => Number(a) - Number(b))
      .forEach(semana => {
        const dados = mapa[semana];
        const comissao = dados.frete * (comissaoPercent / 100);
        const card = document.createElement("div");
        card.className = "week-card week-highlight";
        card.innerHTML = `
          <strong>Semana ${semana}</strong>
          Frete: ${formatarMoeda(dados.frete)}<br>
          Comissão (${comissaoPercent}%): ${formatarMoeda(comissao)}<br>
          Peso: ${formatarNumero(dados.peso / 1000)} t<br>
          Viagens: ${dados.viagens}
        `;
        resumoSemanasGeralWrapper.appendChild(card);
      });

    return semanas.map(semana => ({ semana: Number(semana), frete: mapa[semana].frete }));
  }

  function atualizarIndicadores(listaFretes, ranking, resumoSemanas) {
    const totalFrete = listaFretes.reduce((acc, f) => acc + (Number(f.freteTotal) || 0), 0);
    const totalPeso = listaFretes.reduce((acc, f) => acc + (Number(f.pesoLiquido) || 0), 0);
    const viagens = listaFretes.length;

    indicadorFreteMedioSpan.textContent = viagens ? formatarMoeda(totalFrete / viagens) : "R$ 0,00";
    indicadorPesoMedioSpan.textContent = viagens ? `${formatarNumero(totalPeso / viagens / 1000)} t` : "0,00 t";

    if (resumoSemanas.length) {
      const ordenadas = [...resumoSemanas].sort((a, b) => b.frete - a.frete);
      indicadorSemanaAltaSpan.textContent = `Semana ${ordenadas[0].semana}`;
      indicadorSemanaBaixaSpan.textContent = `Semana ${ordenadas[ordenadas.length - 1].semana}`;
    } else {
      indicadorSemanaAltaSpan.textContent = "-";
      indicadorSemanaBaixaSpan.textContent = "-";
    }

    rankingMotoristasLista.innerHTML = "";
    if (ranking.length) {
      ranking.slice(0, 5).forEach(item => {
        const li = document.createElement("li");
        li.textContent = `${item.nome} — ${formatarMoeda(item.frete)}`;
        rankingMotoristasLista.appendChild(li);
      });
    } else {
      const vazio = document.createElement("li");
      vazio.textContent = "Sem registros";
      vazio.className = "summary-subtext";
      rankingMotoristasLista.appendChild(vazio);
    }
  }

  function preencherTabelaFretesChefe(fretesLista) {
    tabelaFretesChefeBody.innerHTML = "";

    fretesLista
      .sort((a, b) => (a.data || "").localeCompare(b.data || ""))
      .forEach(f => {
        const tr = document.createElement("tr");
        const tdData = document.createElement("td");
        tdData.textContent = f.data || "-";

        const tdSemana = document.createElement("td");
        const semana = f.semana || calcularSemanaDoMes(f.data);
        tdSemana.innerHTML = semana ? `<span class="badge badge-week">Sem ${semana}</span>` : "-";

        const tdMotorista = document.createElement("td");
        tdMotorista.textContent = f.motoristaNome || "-";

        const tdCaminhao = document.createElement("td");
        tdCaminhao.textContent = f.caminhaoId || "-";

        const tdNota = document.createElement("td");
        tdNota.textContent = f.nota || "-";

        const tdCte = document.createElement("td");
        tdCte.textContent = f.cte || "-";

        const tdPeso = document.createElement("td");
        tdPeso.className = "text-right";
        tdPeso.textContent = f.pesoLiquido != null ? formatarNumero(f.pesoLiquido) : "-";

        const tdValorTon = document.createElement("td");
        tdValorTon.className = "text-right";
        tdValorTon.textContent = f.valorTonelada != null ? formatarMoeda(f.valorTonelada) : "-";

        const tdFrete = document.createElement("td");
        tdFrete.className = "text-right";
        tdFrete.textContent = f.freteTotal != null ? formatarMoeda(f.freteTotal) : "-";

        tr.appendChild(tdData);
        tr.appendChild(tdSemana);
        tr.appendChild(tdMotorista);
        tr.appendChild(tdCaminhao);
        tr.appendChild(tdNota);
        tr.appendChild(tdCte);
        tr.appendChild(tdPeso);
        tr.appendChild(tdValorTon);
        tr.appendChild(tdFrete);

        tabelaFretesChefeBody.appendChild(tr);
      });
  }

  tabButtons.forEach(btn => {
    btn.addEventListener("click", () => {
      const tabId = btn.dataset.tab;
      tabButtons.forEach(b => b.classList.remove("active"));
      tabContents.forEach(c => c.classList.add("hidden"));
      btn.classList.add("active");
      document.getElementById(tabId)?.classList.remove("hidden");
    });
  });

  function obterMesReferenciaChefe() {
    return filtroMesChefeInput.value || new Date().toISOString().slice(0, 7);
  }

  document.getElementById("btnAplicarFiltroChefe")?.addEventListener("click", () => {
    atualizarVisaoChefe();
    atualizarGraficoDesempenho();
  });

  [filtroMotoristaChefeSelect, filtroCaminhaoChefeSelect].forEach(selectEl => {
    selectEl?.addEventListener("change", () => {
      atualizarVisaoChefe();
      atualizarGraficoDesempenho();
    });
  });

  percentualComissaoChefeInput?.addEventListener("change", () => {
    const valor = obterPercentualComissao();
    percentualComissaoChefeInput.value = valor;
    atualizarVisaoChefe();
  });

  function atualizarVisaoChefe() {
    if (!ehAdmin()) return;
    const mesSelecionado = obterMesReferenciaChefe();
    if (!mesSelecionado) return;
    const comissaoPercent = obterPercentualComissao();
    const fretesFiltrados = obterFretesFiltrados();
    preencherTabelaFretesChefe(fretesFiltrados);
    const { totalFolha, ranking } = renderizarCardsMotoristas(fretesFiltrados, comissaoPercent);
    renderizarResumoMes(fretesFiltrados, comissaoPercent, totalFolha);
    const resumoSemanas = renderizarResumoSemanalGeral(fretesFiltrados, comissaoPercent);
    atualizarIndicadores(fretesFiltrados, ranking, resumoSemanas);
  }

  function formatarMesCurto(anoMes) {
    if (!anoMes) return "";
    const [ano, mes] = anoMes.split("-");
    return `${mes}/${ano}`;
  }

  function gerarDadosSemanaisGrafico() {
    const mesSelecionado = obterMesReferenciaChefe();
    const fretesMes = obterFretesFiltrados();
    const mapa = {};

    fretesMes.forEach(f => {
      const semana = f.semana || calcularSemanaDoMes(f.data);
      const total = typeof f.freteTotal === "number" ? f.freteTotal : parseFloat(f.freteTotal);
      if (!semana || isNaN(total)) return;
      mapa[semana] = (mapa[semana] || 0) + total;
    });

    const semanasOrdenadas = Object.keys(mapa).sort((a, b) => Number(a) - Number(b));
    return {
      labels: semanasOrdenadas.map(sem => `Sem ${sem}`),
      valores: semanasOrdenadas.map(sem => Number(mapa[sem].toFixed(2))),
      descricao: `Total semanal (${formatarMesCurto(mesSelecionado)})`
    };
  }

  function gerarDadosMensaisGrafico() {
    const mapa = {};

    fretes.forEach(f => {
      if (!f.data) return;
      const total = typeof f.freteTotal === "number" ? f.freteTotal : parseFloat(f.freteTotal);
      if (isNaN(total)) return;
      const chave = f.data.slice(0, 7);
      if (!chave) return;
      mapa[chave] = (mapa[chave] || 0) + total;
    });

    const mesesOrdenados = Object.keys(mapa).sort((a, b) => a.localeCompare(b));
    return {
      labels: mesesOrdenados.map(formatarMesCurto),
      valores: mesesOrdenados.map(mes => Number(mapa[mes].toFixed(2))),
      descricao: "Total mensal (histórico)"
    };
  }

  function gerarDadosAnuaisGrafico() {
    const mapa = {};

    fretes.forEach(f => {
      if (!f.data) return;
      const total = typeof f.freteTotal === "number" ? f.freteTotal : parseFloat(f.freteTotal);
      if (isNaN(total)) return;
      const ano = f.data.slice(0, 4);
      if (!ano) return;
      mapa[ano] = (mapa[ano] || 0) + total;
    });

    const anosOrdenados = Object.keys(mapa).sort((a, b) => a.localeCompare(b));
    return {
      labels: anosOrdenados,
      valores: anosOrdenados.map(ano => Number(mapa[ano].toFixed(2))),
      descricao: "Total anual"
    };
  }

  function obterDatasetGrafico(tipo) {
    switch (tipo) {
      case "meses":
        return gerarDadosMensaisGrafico();
      case "anos":
        return gerarDadosAnuaisGrafico();
      default:
        return gerarDadosSemanaisGrafico();
    }
  }

  function atualizarGraficoDesempenho() {
    if (!chartCanvas || typeof Chart === "undefined" || !ehAdmin()) return;
    const tipo = chartRangeSelect?.value || "semanas";
    const dataset = obterDatasetGrafico(tipo);
    const possuiDados = dataset.labels.length > 0;

    chartEmptyMessage?.classList.toggle("hidden", possuiDados);

    if (!desempenhoChart) {
      const ctx = chartCanvas.getContext("2d");
      desempenhoChart = new Chart(ctx, {
        type: "line",
        data: {
          labels: dataset.labels,
          datasets: [
            {
              label: dataset.descricao,
              data: dataset.valores,
              borderColor: "#111827",
              backgroundColor: "rgba(17, 24, 39, 0.25)",
              tension: 0.3,
              fill: true,
              pointRadius: 4,
              pointBackgroundColor: "#111827"
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: true },
            tooltip: {
              callbacks: {
                label: context => formatarMoeda(context.parsed.y || 0)
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: valor => formatarMoeda(Number(valor))
              }
            }
          }
        }
      });
      return;
    }

    desempenhoChart.data.labels = dataset.labels;
    desempenhoChart.data.datasets[0].data = dataset.valores;
    desempenhoChart.data.datasets[0].label = dataset.descricao;
    desempenhoChart.update();
  }

  function atualizarTabelaSalarios() {
    tabelaSalariosBody.innerHTML = "";
    const ordenados = [...motoristas].sort((a, b) => a.nome.localeCompare(b.nome));
    ordenados.forEach(item => {
      const tr = document.createElement("tr");

      const tdNome = document.createElement("td");
      tdNome.textContent = item.nome;

      const tdSalario = document.createElement("td");
      tdSalario.className = "text-right";
      tdSalario.textContent = formatarMoeda(item.salario || 0);

      const tdAcoes = document.createElement("td");
      const btnEditar = document.createElement("button");
      btnEditar.className = "btn btn-secondary";
      btnEditar.style.fontSize = "11px";
      btnEditar.textContent = "Editar";
      btnEditar.addEventListener("click", () => {
        salarioMotoristaNomeInput.value = item.nome;
        salarioMotoristaValorInput.value = item.salario;
      });

      tdAcoes.appendChild(btnEditar);
      tr.appendChild(tdNome);
      tr.appendChild(tdSalario);
      tr.appendChild(tdAcoes);

      tabelaSalariosBody.appendChild(tr);
    });
  }

  function atualizarTabelaMotoristasAdmin() {
    tabelaMotoristasAdminBody.innerHTML = "";
    motoristas.forEach(item => {
      const tr = document.createElement("tr");
      const tdNome = document.createElement("td");
      const nomeInput = document.createElement("input");
      nomeInput.value = item.nome || "";
      nomeInput.addEventListener("change", async () => {
        await db.collection(COLECAO_USUARIOS).doc(item.id).set({ nome: nomeInput.value }, { merge: true });
      });
      tdNome.appendChild(nomeInput);

      const tdEmail = document.createElement("td");
      tdEmail.textContent = item.email || "-";

      const tdSalario = document.createElement("td");
      const salarioInput = document.createElement("input");
      salarioInput.type = "number";
      salarioInput.min = "0";
      salarioInput.step = "0.01";
      salarioInput.value = item.salario || 0;
      salarioInput.addEventListener("change", async () => {
        const val = parseFloat(salarioInput.value.replace(",", "."));
        await db.collection(COLECAO_USUARIOS).doc(item.id).set({ salario: isNaN(val) ? 0 : val }, { merge: true });
      });
      tdSalario.appendChild(salarioInput);

      const tdCaminhao = document.createElement("td");
      const caminhaoInput = document.createElement("input");
      caminhaoInput.value = item.caminhao || "";
      caminhaoInput.addEventListener("change", async () => {
        await db.collection(COLECAO_USUARIOS).doc(item.id).set({ caminhao: caminhaoInput.value }, { merge: true });
      });
      tdCaminhao.appendChild(caminhaoInput);

      const tdAcoes = document.createElement("td");
      const salvarBtn = document.createElement("button");
      salvarBtn.className = "btn btn-primary";
      salvarBtn.textContent = "Salvar";
      salvarBtn.addEventListener("click", async () => {
        const salarioVal = parseFloat(salarioInput.value.replace(",", "."));
        await db.collection(COLECAO_USUARIOS).doc(item.id).set({
          nome: nomeInput.value.trim(),
          salario: isNaN(salarioVal) ? 0 : salarioVal,
          caminhao: caminhaoInput.value.trim()
        }, { merge: true });
      });
      tdAcoes.appendChild(salvarBtn);

      tr.appendChild(tdNome);
      tr.appendChild(tdEmail);
      tr.appendChild(tdSalario);
      tr.appendChild(tdCaminhao);
      tr.appendChild(tdAcoes);

      tabelaMotoristasAdminBody.appendChild(tr);
    });
  }

  function atualizarDatalistMotoristas() {
    motoristasDatalist.innerHTML = "";
    const nomes = new Set();
    motoristas.forEach(m => nomes.add(m.nome));
    fretes.forEach(f => f.motoristaNome && nomes.add(f.motoristaNome));
    Array.from(nomes)
      .filter(Boolean)
      .sort((a, b) => a.localeCompare(b))
      .forEach(nome => {
        const option = document.createElement("option");
        option.value = nome;
        motoristasDatalist.appendChild(option);
      });
  }

  function atualizarGraficoEVisoes() {
    atualizarVisaoChefe();
    atualizarGraficoDesempenho();
  }

  chartRangeSelect?.addEventListener("change", atualizarGraficoEVisoes);

  definirMesAtualChefe();
  aplicarVisibilidadePorPapel();

  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("/service-worker.js").catch(err => {
      console.warn("Não foi possível registrar o service worker.", err);
    });
  }
</script>

</body>
</html>

